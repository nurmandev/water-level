<!DOCTYPE html>
<html>
  <head>
    <%- include('partials/head'); %>
  </head>
  <body>
    <%- include('navbar', { user: user }); %>

    <main>
      <div class="container">
        <h1>Hello, <%= user.username %></h1>
      </div>

      <div id="services" class="services section">
        <div class="container">
          <div class="row">
            <div class="col-lg-8 offset-lg-2">
              <div
                class="section-heading wow fadeInDown"
                data-wow-duration="1s"
                data-wow-delay="0.5s"
              >
                <h2>
                  Welcome to your Dashboard, <em><%= user.username %>!</em>
                </h2>
                <img src="assets/images/heading-line-dec.png" alt="" />
                <p>This is your dashboard where you can manage your account.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="container mt-5">
        <h1>Sensor Data for <%= user.username %></h1>
        <div class="card-deck">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Tank</h5>
              <div class="progress progress-bar-vertical">
                <div
                  class="progress-bar progress-bar-danger bg-info progress-bar-striped progress-bar-animated"
                  role="progressbar"
                  aria-valuenow="<%= sensorData ? sensorData.distance : 0 %>"
                  aria-valuemin="0"
                  aria-valuemax="100"
                  id="tankProgress"
                  style="height: <%= sensorData ? sensorData.distance : 0 %>%"
                >
                  <div class="container">
                    <span class="sr-only" id="tankPercentage"
                      ><%= sensorData ? sensorData.distance : 0 %>%</span
                    >
                  </div>
                </div>
              </div>
              <div class="container">
                <p id="distance">
                  Tank is filled up for: <%= sensorData ? sensorData.distance :
                  0 %>%
                </p>
              </div>
              <div class="card-footer container">
                <small class="text-muted" id="status"
                  >Status: Monitoring...</small
                >
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">History</h5>
              <canvas id="historyChart"></canvas>
            </div>
            <div class="card-footer">
              <small class="text-muted">Last updated # mins ago</small>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="container">
      <h1><%= user.username %> This is your details</h1>
      <table class="table table-bordered">
        <tr>
          <th>Username</th>
          <td><%= user.username %></td>
        </tr>
        <tr>
          <th>Email</th>
          <td><%= user.email %></td>
        </tr>
        <tr>
          <th>Age</th>
          <td><%= user.age %></td>
        </tr>
        <tr>
          <th>Height</th>
          <td><%= user.height %></td>
        </tr>
        <tr>
          <th>Weight</th>
          <td><%= user.weight %></td>
        </tr>
      </table>

      <table class="table table-bordered mt-4">
        <thead>
          <tr>
            <th>Weight</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% if (sensorData) { %>
          <tr>
            <td><%= sensorData.distance %> kg</td>
            <td>Tank is filled up for <%= sensorData.distance %>%</td>
          </tr>
          <% } else { %>
          <tr>
            <td colspan="2">No sensor data available.</td>
          </tr>
          <% } %>
        </tbody>
      </table>

      <a href="/logout" class="btn btn-primary mt-3">LogOut</a>
      <a href="/dashboard" class="btn btn-secondary mt-3">Back to Dashboard</a>
    </div>

    <script>
      const tankProgress = document.getElementById("tankProgress");
      const tankPercentage = document.getElementById("tankPercentage");
      const distanceElement = document.getElementById("distance");
      const statusElement = document.getElementById("status");
      const historyChartElement = document.getElementById("historyChart");

      const historyData = {
        labels: [],
        datasets: [
          {
            label: "Water Level (%)",
            data: [],
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            borderWidth: 1,
          },
        ],
      };

      const historyChart = new Chart(historyChartElement, {
        type: "line",
        data: historyData,
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
            },
          },
        },
      });

      function updateTankData(data) {
        const percentage = ((50 - data.distance) / 50) * 100;
        tankProgress.style.height = `${percentage}%`;
        tankProgress.setAttribute("aria-valuenow", percentage);
        tankPercentage.innerText = `${percentage.toFixed(2)}%`;
        distanceElement.innerText = `Tank is filled up for: ${percentage.toFixed(
          2
        )}%`;
        statusElement.innerText = `Status: Monitoring...`;

        const now = new Date();
        const timeLabel = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
        historyData.labels.push(timeLabel);
        historyData.datasets[0].data.push(percentage);
        historyChart.update();
      }

      async function fetchSensorData() {
        try {
          const response = await fetch("/sensor-data");
          const data = await response.json();
          updateTankData(data);
        } catch (error) {
          console.error("Error fetching sensor data:", error);
        }
      }

      async function startMonitoring() {
        await fetchSensorData();
        setInterval(fetchSensorData, 60000);
      }

      startMonitoring();
    </script>
    <%- include('partials/footer'); %> <%- include('partials/footerSec'); %>
  </body>
</html>
