<!DOCTYPE html>
<html>
  <head>
    <%- include('partials/head'); %>
  </head>
  <body>
    <%- include('navbar', { user: user }); %>

    <main>
      <div class="container">
        <h1>Hello, <%= user.username %></h1>
      </div>

      <div id="services" class="services section">
        <div class="container">
          <div class="row">
            <div class="col-lg-8 offset-lg-2">
              <div
                class="section-heading wow fadeInDown"
                data-wow-duration="1s"
                data-wow-delay="0.5s"
              >
                <h2>
                  Welcome to your Dashboard, <em><%= user.username %>!</em>
                </h2>
                <img src="assets/images/heading-line-dec.png" alt="" />
                <p>This is your dashboard where you can manage your account.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="card-deck">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Tank</h5>
              <div class="progress progress-bar-vertical">
                <div
                  class="progress-bar progress-bar-danger bg-info progress-bar-striped progress-bar-animated"
                  role="progressbar"
                  aria-valuenow="0"
                  aria-valuemin="0"
                  aria-valuemax="100"
                  id="tankProgress"
                  style="height: 0%"
                >
                  <div class="container">
                    <span class="sr-only" id="tankPercentage">0%</span>
                  </div>
                </div>
              </div>
              <div class="container">
                <p id="distance">Tank is filled up for: 0%</p>
              </div>
              <div class="card-footer container">
                <small class="text-muted" id="status"
                  >Status: Monitoring...</small
                >
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">History</h5>
              <canvas id="historyChart"></canvas>
            </div>
            <div class="card-footer">
              <small class="text-muted">Last updated # mins ago</small>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="container">
      <h1><%= user.username %> This is your details</h1>
      <table class="table table-bordered">
        <tr>
          <th>Username</th>
          <td><%= user.username %></td>
        </tr>
        <tr>
          <th>Email</th>
          <td><%= user.email %></td>
        </tr>
        <tr>
          <th>Age</th>
          <td><%= user.age %></td>
        </tr>
        <tr>
          <th>Height</th>
          <td><%= user.height %></td>
        </tr>
        <tr>
          <th>Weight</th>
          <td><%= user.weight %></td>
        </tr>
      </table>
    </div>

    <div class="container">
      <h2>Latest Sensor Data</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Sensor</th>
            <th>Weight (kg)</th>
          </tr>
        </thead>
        <tbody id="sensor-data-body">
          <tr>
            <td id="sensor-type">-</td>
            <td id="sensor-distance">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const historyData = {
        labels: [],
        datasets: [
          {
            label: "Tank Fill Level (%)",
            data: [],
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1,
          },
        ],
      };

      const historyChart = new Chart(
        document.getElementById("historyChart").getContext("2d"),
        {
          type: "line",
          data: historyData,
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
              },
            },
          },
        }
      );

      function fetchData() {
        fetch("http://localhost:3000/sensor-data")
          .then((response) => response.json())
          .then((data) => {
            const distance = data.distance;
            const fillPercentage = ((50 - distance) / 45) * 100; // Assuming 50 cm is empty and 5 cm is full

            document.getElementById(
              "tankProgress"
            ).style.height = `${fillPercentage}%`;
            document.getElementById(
              "tankPercentage"
            ).textContent = `${fillPercentage.toFixed(1)}%`;
            document.getElementById(
              "distance"
            ).textContent = `Tank is filled up for: ${fillPercentage.toFixed(
              1
            )}%`;

            if (distance <= 5) {
              document.getElementById("status").textContent =
                "Status: Water tank is full";
            } else if (distance >= 50) {
              document.getElementById("status").textContent =
                "Status: Water tank is low";
            } else {
              document.getElementById("status").textContent =
                "Status: Monitoring...";
            }

            // Update history chart
            const now = new Date();
            const timeLabel = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
            historyData.labels.push(timeLabel);
            historyData.datasets[0].data.push(fillPercentage);

            if (historyData.labels.length > 10) {
              historyData.labels.shift();
              historyData.datasets[0].data.shift();
            }

            historyChart.update();

            // Update last updated time
            const lastUpdatedElement = document.getElementById("lastUpdated");
            lastUpdatedElement.textContent = `${Math.floor(
              (Date.now() - historyChart.lastUpdate) / 60000
            )}`;
            historyChart.lastUpdate = Date.now();
          })
          .catch((error) => console.error("Error fetching data:", error));
      }

      setInterval(fetchData, 5000); // Fetch data every 5 seconds
      historyChart.lastUpdate = Date.now();
    </script>
    <%- include('partials/footer'); %>
  </body>
</html>
